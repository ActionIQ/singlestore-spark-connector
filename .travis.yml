dist: trusty
jdk: oraclejdk8
language: scala
scala:
- 2.11.11
services:
- docker

before_cache:
- rm -fv $HOME/.ivy2/.sbt.ivy.lock
- find $HOME/.ivy2/cache -name "ivydata-*.properties" -print -delete
- find $HOME/.sbt        -name "*.lock"               -print -delete

cache:
  directories:
  - "$HOME/.ivy2"
  - "$HOME/.sbt"

env:
  matrix:
  - DRIVER=mariadb
  - DRIVER=mysql5
  - DRIVER=mysql8
  global:
  - secure: "XjQURTMQLgvUlr0U+D0oyIHpoRF1O0XPNsmUNPU1J0m8ho5vRK0/0aMeiujGC8tvVIdZ/95Q5lBLt/hbL5mSlQOrswWQj9N7tKpAxSApE32N5WUh7acdeyteiLDJYBx8+9TAVOF1VsaUZOGK+g7FpM6uf8ikAIdfn6gpHQowv8I="
  - secure: "jpSeK4VzBLgxYU5cYkgrwzfyLbVp2WmnN5crv+4txOrXiYoDDZmt7XTddQDHEVb07fWiPSk2G7O6bNxWumCO3gwNmLlcsKwfStF2uU3FiGXG3MMVQrUjIPvRr5wFbeNQMIMHjmvvj5T5866pawZhjz6qCHFbjls7odQAepW6PMU="
  - secure: "RsoGCkw1zlpDD1R25FOhfEE3c+fskjipmZ227k9kGJS2NXHLAylGQalmkmq9yfDch4O2oUvuucsXL4Z+TQ9o6v4Hff7HKyVNUnF6r57DboRTrpDMpZ/ZtXPbB2QlQVFTeQTuRj3wbcoz3Ezb6mj43xS/rA+UJKud73tXKNJXXfNEGNYpbA/wS9XXxXVsM/SePGn5LaeAkPq2yWjXEL4vuANs5DVNn2Fn9G0QSWUhkvk5ETl1UDBf9aO9rUF7uWLndsLHOeet59MszfTlz/WC2ugau4RXLjO87L7eDYMhq6M5JvLaT+3yGS7fX6nipUbfGSLVtY3DOKoFiroX2m8B+zEbS/RE1PaIkyiPxDR6iiJCEMG7nHhbChXdQr2DqjlyC+pGqSn97Z/EfIwVP5ZKteAUQ8R71tjWubjzxTpkg6ZDMwEbutR6Z9qc8JqA25lIaZmy/EG0ZULsqN8Qz4Xm3WfFhN86HeayGteOK3mYLsM7tsbi0n7lAGt1zwQYsPhjFnNuiDvL08GgGR5CUnLkl1thot3uIJSeMs/0ZzgY0LDlsKslldIPVNXO75psg86x1nA/qUw9lWDi2JFpQaZjGNBo9v0p/rHLhhQUztgNM/ON3sQ7Kmk/VmjUV2/V9KsbccHx+QiE4zEHm6gZV7w2qwax+qCHaO/rAtcFW4gc01M="

jobs:
  include:
    - stage: test
      script:
      - "./scripts/ensure-test-memsql-cluster.sh"
      - export MEMSQL_HOST=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' memsql-spark-utils-test)
      - export MEMSQL_PORT="5506" MEMSQL_USER=root MEMSQL_DB=test
      - sbt ++$TRAVIS_SCALA_VERSION test -Dmysql.driver=$DRIVER
    - stage: publish
      if: tag =~ ^v
      script:
      - openssl aes-256-cbc -K "${encrypted_7cf4e52aa9ef_key}" -iv "${encrypted_7cf4e52aa9ef_iv}" -in ci/secring.asc.enc -out ci/secring.asc -d
      - sbt ++$TRAVIS_SCALA_VERSION publishSigned sonatypeRelease
